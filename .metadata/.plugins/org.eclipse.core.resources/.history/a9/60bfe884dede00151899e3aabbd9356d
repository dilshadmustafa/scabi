/**
 * @author Dilshad Mustafa
 * (c) Dilshad Mustafa
 * All Rights Reserved.
 * @version 1.0
 * @since 29-Feb-2016
 * File Name : DRangeRunner.java
 */
package com.dilmus.dilshad.scabi.client.async;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Future;
import java.util.concurrent.TimeoutException;

import org.apache.http.HttpResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.dilmus.dilshad.scabi.client.DComputeRun;

/**
 * @author Dilshad Mustafa
 *
 */
public class DRangeRunner implements Runnable {

	private final Logger log = LoggerFactory.getLogger(DRangeRunner.class);
	private DComputeAsync m_compute = null;
	private List<DComputeAsyncRun> m_localCRunList = null;
	
	public DRangeRunner(DComputeAsync compute, int start, int end) {
		m_compute = compute;
		
		m_localCRunList = new ArrayList<DComputeAsyncRun>();
		synchronized(m_compute) {
			List<DComputeAsyncRun> crunList = compute.getCRunList();
			m_localCRunList.addAll(crunList);
			
			/* Not used
			for (DComputeAsyncRun crun : crunList) {
				if (false == m_localCRunList.contains(crun))
					m_localCRunList.add(crun);
			}
			*/
		}
		
		
	}


	@Override
	public void run() {
		
		for (DComputeAsyncRun crun : m_localCRunList) {
			
			try {
			crun.run();
			}
			catch (Error | RuntimeException e) {
				e.printStackTrace();
				throw e;
		    } catch (Exception e) {
		        e.printStackTrace();
		        throw new RuntimeException(e);
		    } catch (Throwable e) {
		    	e.printStackTrace();
		        throw new RuntimeException(e);
		    }

		}
		
		String result = null;
		HttpResponse httpResponse = null;
		
		for (DComputeAsyncRun crun : m_localCRunList) {
			Future<HttpResponse> futureHttpResponse = crun.getFutureHttpResponse();
			if (futureHttpResponse != null) {
				try {
					httpResponse = DComputeNoBlock.get(futureHttpResponse);
				} catch (InterruptedException | ExecutionException | TimeoutException e) {
					
					e.printStackTrace();
				}
				result = DComputeNoBlock.getResult(httpResponse);
				log.debug("result : {}", result);
				
				DComputeAsyncConfig config = crun.getConfig();
				synchronized (config) {
					config.setResult(crun.getSU(), result);
				}
				
				
			}
			
			
			
		}
		
		
	}
	
	
	
}
